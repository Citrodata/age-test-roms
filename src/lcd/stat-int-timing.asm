DEF ROM_IS_CGB_COMPATIBLE EQU 1
INCLUDE "test-setup.inc"
INCLUDE "lcd/stat-int-timing.inc"



; Verified:
;   passes on CPU CGB E - CPU-CGB-06 (2021-06-28)
;   passes on CPU CGB B - CPU-CGB-02 (2021-06-28)
;   passes on DMG-CPU A/B/C TODO what device is this exactly? (2021-06-28)
EXPECTED_TEST_RESULTS_DMG:
    ; number of test result rows
    DB 5
    ; mode 0 (scanline >0)
    DB $88, $8A, $88, $8A, $88, $8A, $88, $8A ; SCX 0 - 3
    DB $88, $8A, $88, $8A, $88, $8A, $88, $8A ; SCX 4 - 7
    DB $88, $8A, $88, $8A, $00, $00, $00, $00 ; SCX 8 - 9
    ; mode 2 (scanline >0)
    DB $A0, $A2, $A0, $A2, $00, $00, $00, $00 ; SCX 0, 7
    ; mode 1
    DB $90, $92, $90, $92, $00, $00, $00, $00 ; SCX 0, 7

EXPECTED_TEST_RESULTS_CGB:
    ; number of test result rows
    DB 10
    ;
    ; single speed
    ;
    ; mode 0 (scanline >0)
    DB $88, $8A, $88, $8A, $88, $8A, $88, $8A ; SCX 0 - 3
    DB $88, $8A, $88, $8A, $88, $8A, $88, $8A ; SCX 4 - 7
    DB $88, $8A, $88, $8A, $00, $00, $00, $00 ; SCX 8 - 9
    ; mode 2 (scanline >0)
    DB $A0, $A2, $A0, $A2, $00, $00, $00, $00 ; SCX 0, 7
    ; mode 1
    DB $90, $92, $90, $92, $00, $00, $00, $00 ; SCX 0, 7
    ;
    ; double speed
    ;
    ; mode 0 (scanline >0)
    DB $88, $8A, $88, $8A, $88, $8A, $88, $8A ; SCX 0 - 3
    DB $88, $8A, $88, $8A, $88, $8A, $88, $8A ; SCX 4 - 7
    DB $88, $8A, $88, $8A, $00, $00, $00, $00 ; SCX 8 - 9
    ; mode 2 (scanline >0)
    DB $A0, $A2, $A0, $A2, $00, $00, $00, $00 ; SCX 0, 7
    ; mode 1
    DB $90, $92, $90, $92, $00, $00, $00, $00 ; SCX 0, 7



run_test:
    ld hl, TEST_RESULTS

    ; 335 nops -> within mode 2 of scanline 3
    TEST_STAT_INT 0, 335, STATF_MODE00, 36
    TEST_STAT_INT 0, 335, STATF_MODE00, 37
    TEST_STAT_INT 1, 335, STATF_MODE00, 36
    TEST_STAT_INT 1, 335, STATF_MODE00, 37
    TEST_STAT_INT 2, 335, STATF_MODE00, 36
    TEST_STAT_INT 2, 335, STATF_MODE00, 37
    TEST_STAT_INT 3, 335, STATF_MODE00, 36
    TEST_STAT_INT 3, 335, STATF_MODE00, 37
    TEST_STAT_INT 4, 335, STATF_MODE00, 36
    TEST_STAT_INT 4, 335, STATF_MODE00, 37
    TEST_STAT_INT 5, 335, STATF_MODE00, 36
    TEST_STAT_INT 5, 335, STATF_MODE00, 37
    TEST_STAT_INT 6, 335, STATF_MODE00, 36
    TEST_STAT_INT 6, 335, STATF_MODE00, 37
    TEST_STAT_INT 7, 335, STATF_MODE00, 36
    TEST_STAT_INT 7, 335, STATF_MODE00, 37
    TEST_STAT_INT 8, 335, STATF_MODE00, 36
    TEST_STAT_INT 8, 335, STATF_MODE00, 37
    TEST_STAT_INT 9, 335, STATF_MODE00, 36
    TEST_STAT_INT 9, 335, STATF_MODE00, 37
    PAD_RESULTS 4

    TEST_STAT_INT 0, 335, STATF_MODE10, 102
    TEST_STAT_INT 0, 335, STATF_MODE10, 103
    TEST_STAT_INT 7, 335, STATF_MODE10, 102
    TEST_STAT_INT 7, 335, STATF_MODE10, 103
    PAD_RESULTS 4

    TEST_STAT_INT 0, 335, STATF_MODE01, 1241
    TEST_STAT_INT 0, 335, STATF_MODE01, 1242
    TEST_STAT_INT 7, 335, STATF_MODE01, 1241
    TEST_STAT_INT 7, 335, STATF_MODE01, 1242
    PAD_RESULTS 4

    CP_IS_CGB
    jr nz, .run_cgb_tests
    ld hl, EXPECTED_TEST_RESULTS_DMG
    ret

.run_cgb_tests:
    SWITCH_SPEED

    ; 335 nops -> within mode 2 of scanline 3
    TEST_STAT_INT 0, 770, STATF_MODE00, 88
    TEST_STAT_INT 0, 770, STATF_MODE00, 89
    TEST_STAT_INT 1, 770, STATF_MODE00, 88
    TEST_STAT_INT 1, 770, STATF_MODE00, 89
    TEST_STAT_INT 2, 770, STATF_MODE00, 88
    TEST_STAT_INT 2, 770, STATF_MODE00, 89
    TEST_STAT_INT 3, 770, STATF_MODE00, 87
    TEST_STAT_INT 3, 770, STATF_MODE00, 88
    TEST_STAT_INT 4, 770, STATF_MODE00, 87
    TEST_STAT_INT 4, 770, STATF_MODE00, 88
    TEST_STAT_INT 5, 770, STATF_MODE00, 84
    TEST_STAT_INT 5, 770, STATF_MODE00, 85
    TEST_STAT_INT 6, 770, STATF_MODE00, 84
    TEST_STAT_INT 6, 770, STATF_MODE00, 85
    TEST_STAT_INT 7, 770, STATF_MODE00, 84
    TEST_STAT_INT 7, 770, STATF_MODE00, 85
    TEST_STAT_INT 8, 770, STATF_MODE00, 88
    TEST_STAT_INT 8, 770, STATF_MODE00, 89
    TEST_STAT_INT 9, 770, STATF_MODE00, 88
    TEST_STAT_INT 9, 770, STATF_MODE00, 89
    PAD_RESULTS 4

    TEST_STAT_INT 0, 770, STATF_MODE10, 216
    TEST_STAT_INT 0, 770, STATF_MODE10, 217
    TEST_STAT_INT 7, 770, STATF_MODE10, 216
    TEST_STAT_INT 7, 770, STATF_MODE10, 217
    PAD_RESULTS 4

    TEST_STAT_INT 0, 770, STATF_MODE01, 2495
    TEST_STAT_INT 0, 770, STATF_MODE01, 2496
    TEST_STAT_INT 7, 770, STATF_MODE01, 2495
    TEST_STAT_INT 7, 770, STATF_MODE01, 2496
    PAD_RESULTS 4

    SWITCH_SPEED
    ld hl, EXPECTED_TEST_RESULTS_CGB
    ret
